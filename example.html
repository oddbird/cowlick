<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hello React!</title>
    <script src="https://npmcdn.com/react@15.3.1/dist/react-with-addons.js"></script>
    <script src="https://npmcdn.com/react-dom@15.3.1/dist/react-dom.js"></script>
    <script src="https://github.com/pegjs/pegjs/releases/download/v0.10.0/peg-0.10.0.js"></script>
    <script id="grammar" type="text/pegjs">
document
    = ws? doctype? root:tag ws? {
      return root;
    }
tag
    = tag:open_tag children:(text / curly / tag)* close_tag {
      return {
        tag: tag.name,
        attrs: tag.attrs,
        children
      };
    }
open_tag
  = '<' name:name attrs:(attribute)* '>' {
    return {
      name,
      attrs
    };
  }
close_tag
  = '</' name '>'
doctype
  = '<!doctype'i name '>'
text
  = text:[^<{]+ {
    return text.join('');
  }
attribute
    = ws name:name value:('=' value)? {
      return {
        name,
        value: value ? value[1] : true
      };
    }
name
  = name:([A-Za-z][A-Za-z0-9-]*) {
    return name[0] + name[1].join('');
  }
identifier
  = name:([a-zA-Z_][a-zA-Z0-9_]*) {
    return name[0] + name[1].join('');
  }
value
    = '"' value:[^"]+ '"' {
      return value.join('');
    }
    / "'" value:[^']+ "'" {
      return value.join('');
    }
    / value:[^<> ]+ {
      return value.join('');
    }
ws
    = [\n ]+ { }
curly
  = '{' inner:(variable / text) '}' {
    return (inner.type === 'variable') ? inner : '{' + inner + '}'
  }
variable
  = '{' ws? name:identifier ws? '}' {
    return {
      type: 'variable',
      name
    }
  }
    </script>
    <script type="text/plain" id="example">
      <div class="foo"><a href="http://oddbird.net">Hello, {{org}}!</a> there</div>
    </script>
  </head>
  <body>
    <div id="output"></div>
    <script>
      function escapeLiteral(s) {
        s = s.replace(/\\/g, '\\\\');
        s = s.replace(/"/g, '\\"');
        s = s.replace(/\n/g, '\\n');
        s = s.replace(/\r/g, '\\r');
        s = s.replace(/\t/g, '\\t');
        return s;
      }

      class Compiler {
        constructor () {
          this.out = [];
          this.emitLine('(function fn (context) {');
          this.emitLine('var stack = [];');
          this.emitLine('var children = [];');
          this.emitLine('var node;');
        }

        emitLine (code) {
          this.out.push(code + '\n');
        }

        compileNode(node) {
          if (typeof node === 'string') {
            this.emitLine('node = "' + escapeLiteral(node) + '";');
          } else if (node.type === 'variable') {
            this.emitLine('node = context["' + node.name + '"];');
          } else {
            const attrs = {};
            node.attrs.forEach((attr) => {
              var name = attr.name;
              if (name == 'class') name = 'className';
              if (name == 'for') name = 'htmlFor';
              attrs[name] = attr.value;
            });
            if (node.children.length) {
              node.children.forEach((child) => {
                this.emitLine('stack.push(children); children = [];');
                this.compileNode(child);
                this.emitLine('children = stack.pop();');
                this.emitLine('children.push(node);');
              });
              this.emitLine('node = React.createElement("' +
                node.tag + '", ' + JSON.stringify(attrs) + ', children);');
            } else {
              this.emitLine('node = React.createElement("' +
                node.tag + '", ' + JSON.stringify(attrs) + ', []);');
            }
          }
        }

        getCode () {
          this.emitLine('return node;');
          this.emitLine('})');
          return this.out.join('');
        }
      }

      const grammar = document.getElementById('grammar').text;
      const parser = peg.generate(grammar);

      class Template {
        constructor (s) {
          const tree = parser.parse(s);
          const code = this.compile(tree);
          this.compiled = eval(code);
        }

        compile (tree) {
          const compiler = new Compiler();
          compiler.compileNode(tree);
          const result = compiler.getCode();
          console.log(result);
          return result;
        }

        render (context) {
          const result = this.compiled(context);
          console.log(result);
          return result;
        }
      }

      const tplStr = document.getElementById('example').text;
      var tpl = new Template(tplStr);
      ReactDOM.render(
        tpl.render({org: 'OddBird'}),
        document.getElementById('output')
      );
    </script>
  </body>
</html>
